var M=Object.defineProperty;var N=(t,i,e)=>i in t?M(t,i,{enumerable:!0,configurable:!0,writable:!0,value:e}):t[i]=e;var l=(t,i,e)=>N(t,typeof i!="symbol"?i+"":i,e);import{w as I}from"./with-props-DY0BKT3b.js";import{j as d}from"./jsx-runtime-BjG_zV1W.js";import{r as f,O as U}from"./chunk-KNED5TY2-Bs4SCV26.js";import{c as y,M as D,U as F}from"./MusicPlayerContext-CrUg4Wnu.js";import{u as b}from"./use-window-event-gPnLv2ol.js";import{a as x}from"./notifications.store-DJz-Y7bD.js";import"./random-id-CQPYUG5g.js";const P={farewellBackground:!0},O=f.createContext({...P,enable:()=>{},disable:()=>{},toggle:()=>{}}),L=({children:t})=>{const[i,e]=f.useState(P),r=s=>e(n=>({...n,[s]:!0})),o=s=>e(n=>({...n,[s]:!1})),a=s=>e(n=>({...n,[s]:!n[s]}));return d.jsx(O.Provider,{value:{...i,enable:r,disable:o,toggle:a},children:t})},V=t=>c(t,t),c=(t,i)=>typeof t=="object"&&t!==null?{x:t.x||0,y:t.y||0}:{x:t||0,y:i||0},p=t=>typeof t=="object"&&t?c(t):V(t),G=(t,i)=>t.x==i.x&&t.y==i.y,v=(...t)=>t.map(p).reduce((i,e)=>c(i.x+e.x,i.y+e.y)),R=(...t)=>t.map(p).reduce((i,e)=>c(i.x*e.x,i.y*e.y)),S=(t,i)=>v(t,R(i,-1)),T=(t,i)=>{let e=p(t),r=p(i);return c(e.x/r.x,e.y/r.y)},j=t=>{let i=p(t);return Math.sqrt(i.x**2+i.y**2)},Y=t=>T(t,j(t));c(0,0);c(1,1);class k{constructor(){l(this,"id","");l(this,"dimensions",c());l(this,"mousePosition",null);l(this,"scrollPosition",c())}onDimensionsChange(i){this.dimensions=i}onScrollPositionChange(i){this.scrollPosition=i}onMouseMove(i){this.mousePosition=i}update(i){}render(){}}class Q extends k{constructor(e){super();l(this,"gl");l(this,"program");l(this,"bindings",{});l(this,"scale",1);this.gl=e,this.program=e.createProgram()}onDimensionsChange(e){this.dimensions=e}updateViewport(){this.gl.viewport(0,0,this.dimensions.x*this.scale,this.dimensions.y*this.scale)}binding(e,r){return e=="a"?this.gl.getAttribLocation(this.program,`${e}_${r}`):this.gl.getUniformLocation(this.program,`${e}_${r}`)}createBuffer(){return this.gl.createBuffer()}writeBuffer(e,r){return this.gl.bindBuffer(this.gl.ARRAY_BUFFER,e),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array(r),this.gl.STATIC_DRAW),e}writeAndBindBuffer(e,r,o,a=1){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,r),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array(o),this.gl.STATIC_DRAW);let s=this.bindings[e];this.gl.enableVertexAttribArray(s),this.gl.vertexAttribPointer(s,a,this.gl.FLOAT,!1,0,0)}bindBuffer(e,r,o=1){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,r),this.gl.enableVertexAttribArray(this.bindings[e]),this.gl.vertexAttribPointer(this.bindings[e],o,this.gl.FLOAT,!1,0,0)}uniformVec2(e,r){this.gl.uniform2f(this.bindings[e],r.x,r.y)}}const w=(t,i,e)=>{const r=t.createShader(i);return r?(t.shaderSource(r,e),t.compileShader(r),t.getShaderParameter(r,t.COMPILE_STATUS)?r:(console.error("SHADER COMPILATION ERROR",e),console.error(t.getShaderInfoLog(r)),t.deleteShader(r),null)):null},H=(t,i)=>{const e=t.createProgram();for(let r of i)t.attachShader(e,r);return t.linkProgram(e),t.getProgramParameter(e,t.LINK_STATUS)?e:(console.error(t.getProgramInfoLog(e)),t.deleteProgram(e),null)},W=(t,i)=>{const e=t.createTexture();t.bindTexture(t.TEXTURE_2D,e),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,1,1,0,t.RGBA,t.UNSIGNED_BYTE,new Uint8Array([0,0,0,0]));const r=new Image;return r.onload=()=>{t.bindTexture(t.TEXTURE_2D,e),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,r),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST)},r.src=i,e},X=(t=1)=>Math.round(Math.random()*t),g=(t=1)=>Math.random()*t,q=(t,i)=>Math.random()>.5?t:i,E=(t,i,e)=>t+(i-t)*e,K=["data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAHUlEQVR4Ae3OAQ0AAAABMP1Lo4UxT3Dg1tGqwhcjpd4D/epMC1wAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAIklEQVR4Ae3MsQ0AAAzCMP5/uuUHGBDCewJMuCM5tkym3gOLZg/xodIpmQAAAABJRU5ErkJggg==","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAMklEQVR4Ae3PSwoAAAQEUNz/zlgrn5KymLc2MyGCW+q6G9mO8HSZ3bgglmTh9oUqCJ8YQAgMB0rhaRAAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAQElEQVR4Ae2RSw4AMAREjfvfuZV01/hNbL0140FkSTlGVYNOMwwqwJschYBW/oLA7O1ZjFfQ7vEiM610sw8sjwsTECAKHmlhcAAAAABJRU5ErkJggg=="],$=`
    attribute vec2 a_position;
    attribute float a_textureIndex;
    attribute float a_opacity;
    uniform float u_pointSize;
    uniform vec2 u_scroll;
    uniform vec2 u_dim;
    uniform vec2 u_scrollPosition;
    varying float v_opacity;
    varying float v_flash;
    varying float v_textureIndex;
    uniform vec2 u_mousePosition;
    
    void main() {
        gl_PointSize = u_pointSize;

        vec2 position = mod(a_position - u_scrollPosition, u_dim);

        //float mouseDistance = sqrt(pow(position.x - u_mousePosition.x, 2.0) + pow(position.y - u_mousePosition.y, 2.0));
        // float threshold = 50.0;
        // float moveDistance = max(0.0, threshold - mouseDistance);
        // vec2 directionToMouse = normalize(position - u_mousePosition);
        // vec2 moveAway = directionToMouse * moveDistance * 1.0;
        // position += moveAway;

        vec2 clipSpace = ((position / u_dim) * 2.0) - 1.0;
        gl_Position = vec4(clipSpace * vec2(1, -1), 0, 1);

        // Pass attributes to the fragment shader
        v_opacity = a_opacity;
        v_textureIndex = a_textureIndex;
        // v_flash = mouseDistance / 50.0;
    }
`,J=`
    precision mediump float;
    uniform sampler2D u_textures[4];
    uniform vec3 u_color;
    uniform float u_flash;
    varying float v_flash;
    varying float v_opacity;
    varying float v_textureIndex;

    void main() {
        vec4 textureColor;

        int texIndex = int(floor(v_textureIndex + 0.5));

        if (texIndex == 0) {
            textureColor = texture2D(u_textures[0], gl_PointCoord);
        } else if (texIndex == 1) {
            textureColor = texture2D(u_textures[1], gl_PointCoord);
        } else if (texIndex == 2) {
            textureColor = texture2D(u_textures[2], gl_PointCoord);
        }  else if (texIndex == 3) {
            textureColor = texture2D(u_textures[3], gl_PointCoord);
        } else {
            // Fallback
            textureColor = vec4(1.0, 0.0, 0.0, 1.0);
        }

        gl_FragColor = vec4(
            (textureColor.rgb * u_color + (
                textureColor.a * u_flash * v_flash * vec3(1.0,1.0,1.0)
            )),
            textureColor.a * v_opacity + ((textureColor.a * u_flash) / 3.0)
        );
    }
`,Z=[{color:"ab6ffa",scroll:c(.3,.3)},{color:"71d5ff",scroll:c(.3,.3),flowSpeed:2.5},{color:"53f3dd",scroll:c(.5,.5)},{color:"cefdff",scroll:c(.5,.5),flowSpeed:3}];class z extends Q{constructor(e){super(e);l(this,"id","farewell");l(this,"textures");l(this,"buffers");l(this,"starfields",[]);l(this,"globalPosition",c());l(this,"globalFlash",0);l(this,"scale",1);l(this,"deltaTimeMultiplier",.002);l(this,"speedMultiplier",1);l(this,"speedMultiplierDecay",1);this.program=H(e,[w(e,e.VERTEX_SHADER,$),w(e,e.FRAGMENT_SHADER,J)]),this.textures=Array(4).fill(0).map((r,o)=>W(e,K[o])),this.bindings={color:this.binding("u","color"),dim:this.binding("u","dim"),flash:this.binding("u","flash"),opacity:this.binding("a","opacity"),position:this.binding("a","position"),textureIndex:this.binding("a","textureIndex"),scroll:this.binding("u","scroll"),scrollPosition:this.binding("u","scrollPosition"),mousePosition:this.binding("u","mousePosition"),pointSize:this.binding("u","pointSize")},this.createStarfields(),this.buffers={texture:this.createBuffer(),opacity:this.createBuffer(),position:this.createBuffer()}}onDimensionsChange(e){this.dimensions=e,this.createStarfields()}isSmallDims(){return this.dimensions.x<100||this.dimensions.y<100}update(e){for(let r of this.starfields)for(let o of r.stars)this.updateStar(r.config,o,e)}createStarfields(){this.starfields=Z.map(e=>this.createStarfield(e))}createStarfield(e){let r={yNodes:[],color:"ffffff",flowSpeed:1,scroll:c(1),...e};r.yNodes=this.createYNodes();let o=this.createStars(r);return{config:r,stars:o}}stepsH(){return 100}stepsW(){return 100}stepSize(){return this.stepsW()}createYNodes(){let e=[],r=g(this.dimensions.y),o=0;for(;this.stepsH()>o;)o++,e.push(r),r+=q(-1,1)*(16*2+g(24*(this.dimensions.y/360)*2));for(let a=0;a<4;a++)e[e.length-1-a]=E(e[e.length-1-a],e[0],y(0,1-a/4,1));return e}createStars(e){let r=this.isSmallDims()?16:128;return new Array(r).fill(0).map(()=>{let a=g(1),s={NodeIndex:X(e.yNodes.length-1),NodePercent:g(1),Distance:4+a*20,Sine:g(Math.PI*2)},n=Math.floor(y(0,Math.pow(1-a,3)*4,3));return{...s,Position:this.targetOfStar(e,s),Opacity:E(.6,0,a*.5),Texture:n}})}targetOfStar({yNodes:e},r){let o=this.stepSize(),a={x:r.NodeIndex*o,y:e[r.NodeIndex]},s={x:(r.NodeIndex+1)*o,y:e[r.NodeIndex+1]},n=v(a,R(S(s,a),c(r.NodePercent))),u=Y(S(s,a));return{x:n.x+-u.x*r.Distance*Math.sin(r.Sine),y:n.y+u.y*r.Distance*Math.sin(r.Sine)}}updateStar(e,r,o=1){r.Sine+=o*e.flowSpeed*this.deltaTimeMultiplier*this.speedMultiplier,r.NodePercent+=o*.25*e.flowSpeed*this.deltaTimeMultiplier*this.speedMultiplier,r.NodePercent>=1&&(r.NodePercent-=1,r.NodeIndex++,r.NodeIndex>=e.yNodes.length-1&&(r.NodeIndex=0,r.Position.x=0)),r.Position=v(r.Position,T(S(this.targetOfStar(e,r),r.Position),c(50,50)))}render(){this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA),this.gl.blendEquation(this.gl.FUNC_ADD),this.gl.enable(this.gl.BLEND),this.gl.useProgram(this.program),this.gl.uniform1f(this.bindings.flash,0),this.uniformVec2("dim",this.dimensions),this.uniformVec2("scrollPosition",this.scrollPosition),this.uniformVec2("mousePosition",this.mousePosition||c(-1,-1)),this.gl.uniform1f(this.bindings.pointSize,this.isSmallDims()?16:32);for(let e=0;e<this.textures.length;e++){const r=this.textures[e];this.gl.activeTexture(this.gl["TEXTURE"+e]),this.gl.bindTexture(this.gl.TEXTURE_2D,r),this.gl.uniform1i(this.gl.getUniformLocation(this.program,`u_textures[${e}]`),e)}for(let e of this.starfields)this.renderDrawStarfield(e)}renderDrawStarfield(e){this.uniformVec2("scroll",e.config.scroll);const r=parseInt(e.config.color.slice(0,2),16)/255,o=parseInt(e.config.color.slice(2,4),16)/255,a=parseInt(e.config.color.slice(4,6),16)/255;this.gl.uniform3f(this.bindings.color,r,o,a);const s=[],n=[],u=[];e.stars.forEach(m=>{s.push(m.Position.x,m.Position.y),n.push(m.Opacity),u.push(m.Texture)}),this.writeAndBindBuffer("position",this.buffers.position,new Float32Array(s),2),this.writeAndBindBuffer("opacity",this.buffers.opacity,new Float32Array(n)),this.writeAndBindBuffer("textureIndex",this.buffers.texture,new Float32Array(u)),this.gl.drawArrays(this.gl.POINTS,0,e.stars.length)}}const ee=({onInitialize:t,onInitializeFail:i,onDestroy:e,onResize:r}={})=>{let o=f.useRef(null),a=f.useRef(null);return f.useEffect(()=>{if(!o.current)return;o.current.width=o.current.clientWidth,o.current.height=o.current.clientHeight;const s=o.current.getContext("webgl2",{antialias:!1,powerPreference:"low-power",desynchronized:!0,failIfMajorPerformanceCaveat:!0});if(!s){console.log("WebGL2RenderingContext initialize failed"),i==null||i();return}return a.current=s,t==null||t(s),s.viewport(0,0,o.current.width,o.current.height),r==null||r(c(o.current.width,o.current.height),o.current),()=>{e==null||e(),a.current=null}},[o.current]),b("resize",()=>{var s;o.current&&(o.current.width=o.current.clientWidth,o.current.height=o.current.clientHeight,(s=a.current)==null||s.viewport(0,0,o.current.width,o.current.height),r==null||r(c(o.current.width,o.current.height),o.current))}),{ref:o,gl:a}},C=({update:t,fps:i=30})=>{f.useEffect(()=>{let e=performance.now();const r=setInterval(()=>{let o=performance.now();t((o-e)/i,o-e),e=o},1e3/i);return()=>clearInterval(r)},[t,i])},te=({render:t,deltaTimeFPS:i=30})=>{C({fps:i,update:(e,r)=>{t(e)}})},re=({effects:t,onDimensionsChange:i,onInitialized:e})=>{const r=f.useRef([]),o=n=>{for(let u of r.current)G(n,u.dimensions)||u.onDimensionsChange(n);i==null||i(n)},{ref:a,gl:s}=ee({onInitialize:n=>{r.current=t.map(([u])=>new u(n)),o({x:n.canvas.width,y:n.canvas.height}),e==null||e()},onDestroy:()=>{r.current=[]},onResize:n=>{o(n)}});return te({render:()=>{var n,u;(n=s.current)==null||n.clearColor(0,0,0,0),(u=s.current)==null||u.clear(s.current.COLOR_BUFFER_BIT);for(let m of r.current)m.render()}}),C({fps:30,update:n=>{for(let u of r.current)u.update(1*n)}}),b("mousemove",n=>{for(let u of r.current)u.onMouseMove(c(n.clientX,n.clientY))}),{ref:a,gl:s,store:r}},ie=()=>{const{ref:t}=re({effects:[[z]]});return d.jsxs("div",{className:"pageBackground",children:[d.jsx("div",{id:"rr1",style:{position:"absolute",left:0,bottom:0}}),d.jsx("div",{id:"rr2",style:{position:"absolute",right:0,bottom:0}}),d.jsx("canvas",{className:"pageBackground",style:{width:"100vw",height:"100vh",imageRendering:"pixelated"},ref:t})]})},oe=({children:t})=>{const i=f.useRef(null),e=f.useRef(null),r=f.useRef(null),[o,a]=f.useState(null),[s,n]=f.useState(!1),[u,m]=f.useState(!1);f.useEffect(()=>{let A=new Audio;return i.current=A,()=>{var h;(h=e.current)==null||h.close(),A.pause(),A.remove(),i.current=null}},[]),f.useEffect(()=>{if(!i.current)return;const A=new AbortController,{signal:h}=A;return i.current.addEventListener("playing",()=>{x.hide("music-error")},{signal:h}),o&&(x.hide("music-nowplaying"),x.show({id:"music-nowplaying",title:"Now Playing",message:o.title,autoClose:5e3})),()=>A.abort()},[o]);const _=()=>{var A;(A=i.current)==null||A.play().then(()=>{e.current=new AudioContext;let h=e.current.createMediaElementSource(i.current);r.current=e.current.createAnalyser(),h.connect(r.current),h.connect(e.current.destination)}).catch(h=>{if(h instanceof DOMException&&h.name=="NotAllowedError"){x.show({id:"music-error",message:"Can't play music, please click anywhere",autoClose:!1,position:"top-center",color:"yellow"});const B=()=>_();window.addEventListener("click",B,{once:!0})}})};return f.useEffect(()=>{i.current&&(i.current.pause(),i.current.src=o?`/assets/music/${o.file}`:"",o&&_())},[o]),d.jsx(D.Provider,{value:{ref:i,loading:s,playing:u,currentSong:o,analyser:r,audioContext:e,changeCurrentSong:a},children:t})},he=I(function(){return d.jsx(L,{children:d.jsx(F,{children:d.jsxs(oe,{children:[d.jsx(ie,{}),d.jsx(U,{})]})})})});export{he as default};
