var I=Object.defineProperty;var U=(t,o,e)=>o in t?I(t,o,{enumerable:!0,configurable:!0,writable:!0,value:e}):t[o]=e;var l=(t,o,e)=>U(t,typeof o!="symbol"?o+"":o,e);import{w as N}from"./with-props-CQIXBpBm.js";import{j as d}from"./jsx-runtime-BjG_zV1W.js";import{r as f,O as D}from"./chunk-XJI4KG32-BjwCt5aT.js";import{u as P,b as _}from"./notifications.store-CaO7o8pC.js";import"./random-id-CQPYUG5g.js";function b(t,o,e){return o===void 0&&e===void 0?t:o!==void 0&&e===void 0?Math.max(t,o):Math.min(o===void 0&&e!==void 0?t:Math.max(t,o),e)}const w={farewellBackground:!0},F=f.createContext({...w,enable:()=>{},disable:()=>{},toggle:()=>{}}),O=({children:t})=>{const[o,e]=f.useState(w),r=s=>e(n=>({...n,[s]:!0})),i=s=>e(n=>({...n,[s]:!1})),a=s=>e(n=>({...n,[s]:!n[s]}));return d.jsx(F.Provider,{value:{...o,enable:r,disable:i,toggle:a},children:t})},R={musicPopout:!1},L=f.createContext({...R,enable:()=>{},disable:()=>{},toggle:()=>{}}),V=({children:t})=>{const[o,e]=f.useState(R),r=s=>e(n=>({...n,[s]:!0})),i=s=>e(n=>({...n,[s]:!1})),a=s=>e(n=>({...n,[s]:!n[s]}));return d.jsx(L.Provider,{value:{...o,enable:r,disable:i,toggle:a},children:t})},j=t=>u(t,t),u=(t,o)=>typeof t=="object"&&t!==null?{x:t.x||0,y:t.y||0}:{x:t||0,y:o||0},p=t=>typeof t=="object"&&t?u(t):j(t),G=(t,o)=>t.x==o.x&&t.y==o.y,v=(...t)=>t.map(p).reduce((o,e)=>u(o.x+e.x,o.y+e.y)),T=(...t)=>t.map(p).reduce((o,e)=>u(o.x*e.x,o.y*e.y)),x=(t,o)=>v(t,T(o,-1)),C=(t,o)=>{let e=p(t),r=p(o);return u(e.x/r.x,e.y/r.y)},Y=t=>{let o=p(t);return Math.sqrt(o.x**2+o.y**2)},Q=t=>C(t,Y(t));u(0,0);u(1,1);class k{constructor(){l(this,"id","");l(this,"dimensions",u());l(this,"mousePosition",null);l(this,"scrollPosition",u())}onDimensionsChange(o){this.dimensions=o}onScrollPositionChange(o){this.scrollPosition=o}onMouseMove(o){this.mousePosition=o}update(o){}render(){}}class H extends k{constructor(e){super();l(this,"gl");l(this,"program");l(this,"bindings",{});l(this,"scale",1);this.gl=e,this.program=e.createProgram()}onDimensionsChange(e){this.dimensions=e}updateViewport(){this.gl.viewport(0,0,this.dimensions.x*this.scale,this.dimensions.y*this.scale)}binding(e,r){return e=="a"?this.gl.getAttribLocation(this.program,`${e}_${r}`):this.gl.getUniformLocation(this.program,`${e}_${r}`)}createBuffer(){return this.gl.createBuffer()}writeBuffer(e,r){return this.gl.bindBuffer(this.gl.ARRAY_BUFFER,e),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array(r),this.gl.STATIC_DRAW),e}writeAndBindBuffer(e,r,i,a=1){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,r),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array(i),this.gl.STATIC_DRAW);let s=this.bindings[e];this.gl.enableVertexAttribArray(s),this.gl.vertexAttribPointer(s,a,this.gl.FLOAT,!1,0,0)}bindBuffer(e,r,i=1){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,r),this.gl.enableVertexAttribArray(this.bindings[e]),this.gl.vertexAttribPointer(this.bindings[e],i,this.gl.FLOAT,!1,0,0)}uniformVec2(e,r){this.gl.uniform2f(this.bindings[e],r.x,r.y)}}const y=(t,o,e)=>{const r=t.createShader(o);return r?(t.shaderSource(r,e),t.compileShader(r),t.getShaderParameter(r,t.COMPILE_STATUS)?r:(console.error("SHADER COMPILATION ERROR",e),console.error(t.getShaderInfoLog(r)),t.deleteShader(r),null)):null},W=(t,o)=>{const e=t.createProgram();for(let r of o)t.attachShader(e,r);return t.linkProgram(e),t.getProgramParameter(e,t.LINK_STATUS)?e:(console.error(t.getProgramInfoLog(e)),t.deleteProgram(e),null)},X=(t,o)=>{const e=t.createTexture();t.bindTexture(t.TEXTURE_2D,e),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,1,1,0,t.RGBA,t.UNSIGNED_BYTE,new Uint8Array([0,0,0,0]));const r=new Image;return r.onload=()=>{t.bindTexture(t.TEXTURE_2D,e),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,r),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST)},r.src=o,e},q=(t=1)=>Math.round(Math.random()*t),m=(t=1)=>Math.random()*t,K=(t,o)=>Math.random()>.5?t:o,E=(t,o,e)=>t+(o-t)*e,J=["data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAHUlEQVR4Ae3OAQ0AAAABMP1Lo4UxT3Dg1tGqwhcjpd4D/epMC1wAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAIklEQVR4Ae3MsQ0AAAzCMP5/uuUHGBDCewJMuCM5tkym3gOLZg/xodIpmQAAAABJRU5ErkJggg==","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAMklEQVR4Ae3PSwoAAAQEUNz/zlgrn5KymLc2MyGCW+q6G9mO8HSZ3bgglmTh9oUqCJ8YQAgMB0rhaRAAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAQElEQVR4Ae2RSw4AMAREjfvfuZV01/hNbL0140FkSTlGVYNOMwwqwJschYBW/oLA7O1ZjFfQ7vEiM610sw8sjwsTECAKHmlhcAAAAABJRU5ErkJggg=="],$=`
    attribute vec2 a_position;
    attribute float a_textureIndex;
    attribute float a_opacity;
    uniform float u_pointSize;
    uniform vec2 u_scroll;
    uniform vec2 u_dim;
    uniform vec2 u_scrollPosition;
    varying float v_opacity;
    varying float v_flash;
    varying float v_textureIndex;
    uniform vec2 u_mousePosition;
    
    void main() {
        gl_PointSize = u_pointSize;

        vec2 position = mod(a_position - u_scrollPosition, u_dim);

        //float mouseDistance = sqrt(pow(position.x - u_mousePosition.x, 2.0) + pow(position.y - u_mousePosition.y, 2.0));
        // float threshold = 50.0;
        // float moveDistance = max(0.0, threshold - mouseDistance);
        // vec2 directionToMouse = normalize(position - u_mousePosition);
        // vec2 moveAway = directionToMouse * moveDistance * 1.0;
        // position += moveAway;

        vec2 clipSpace = ((position / u_dim) * 2.0) - 1.0;
        gl_Position = vec4(clipSpace * vec2(1, -1), 0, 1);

        // Pass attributes to the fragment shader
        v_opacity = a_opacity;
        v_textureIndex = a_textureIndex;
        // v_flash = mouseDistance / 50.0;
    }
`,Z=`
    precision mediump float;
    uniform sampler2D u_textures[4];
    uniform vec3 u_color;
    uniform float u_flash;
    varying float v_flash;
    varying float v_opacity;
    varying float v_textureIndex;

    void main() {
        vec4 textureColor;

        int texIndex = int(floor(v_textureIndex + 0.5));

        if (texIndex == 0) {
            textureColor = texture2D(u_textures[0], gl_PointCoord);
        } else if (texIndex == 1) {
            textureColor = texture2D(u_textures[1], gl_PointCoord);
        } else if (texIndex == 2) {
            textureColor = texture2D(u_textures[2], gl_PointCoord);
        }  else if (texIndex == 3) {
            textureColor = texture2D(u_textures[3], gl_PointCoord);
        } else {
            // Fallback
            textureColor = vec4(1.0, 0.0, 0.0, 1.0);
        }

        gl_FragColor = vec4(
            (textureColor.rgb * u_color + (
                textureColor.a * u_flash * v_flash * vec3(1.0,1.0,1.0)
            )),
            textureColor.a * v_opacity + ((textureColor.a * u_flash) / 3.0)
        );
    }
`,z=[{color:"ab6ffa",scroll:u(.3,.3)},{color:"71d5ff",scroll:u(.3,.3),flowSpeed:2.5},{color:"53f3dd",scroll:u(.5,.5)},{color:"cefdff",scroll:u(.5,.5),flowSpeed:3}];class ee extends H{constructor(e){super(e);l(this,"id","farewell");l(this,"textures");l(this,"buffers");l(this,"starfields",[]);l(this,"globalPosition",u());l(this,"globalFlash",0);l(this,"scale",1);l(this,"deltaTimeMultiplier",.002);l(this,"speedMultiplier",1);l(this,"speedMultiplierDecay",1);this.program=W(e,[y(e,e.VERTEX_SHADER,$),y(e,e.FRAGMENT_SHADER,Z)]),this.textures=Array(4).fill(0).map((r,i)=>X(e,J[i])),this.bindings={color:this.binding("u","color"),dim:this.binding("u","dim"),flash:this.binding("u","flash"),opacity:this.binding("a","opacity"),position:this.binding("a","position"),textureIndex:this.binding("a","textureIndex"),scroll:this.binding("u","scroll"),scrollPosition:this.binding("u","scrollPosition"),mousePosition:this.binding("u","mousePosition"),pointSize:this.binding("u","pointSize")},this.createStarfields(),this.buffers={texture:this.createBuffer(),opacity:this.createBuffer(),position:this.createBuffer()}}onDimensionsChange(e){this.dimensions=e,this.createStarfields()}isSmallDims(){return this.dimensions.x<100||this.dimensions.y<100}update(e){for(let r of this.starfields)for(let i of r.stars)this.updateStar(r.config,i,e)}createStarfields(){this.starfields=z.map(e=>this.createStarfield(e))}createStarfield(e){let r={yNodes:[],color:"ffffff",flowSpeed:1,scroll:u(1),...e};r.yNodes=this.createYNodes();let i=this.createStars(r);return{config:r,stars:i}}stepsH(){return 100}stepsW(){return 100}stepSize(){return this.stepsW()}createYNodes(){let e=[],r=m(this.dimensions.y),i=0;for(;this.stepsH()>i;)i++,e.push(r),r+=K(-1,1)*(16*2+m(24*(this.dimensions.y/360)*2));for(let a=0;a<4;a++)e[e.length-1-a]=E(e[e.length-1-a],e[0],b(0,1-a/4,1));return e}createStars(e){let r=this.isSmallDims()?16:128;return new Array(r).fill(0).map(()=>{let a=m(1),s={NodeIndex:q(e.yNodes.length-1),NodePercent:m(1),Distance:4+a*20,Sine:m(Math.PI*2)},n=Math.floor(b(0,Math.pow(1-a,3)*4,3));return{...s,Position:this.targetOfStar(e,s),Opacity:E(.6,0,a*.5),Texture:n}})}targetOfStar({yNodes:e},r){let i=this.stepSize(),a={x:r.NodeIndex*i,y:e[r.NodeIndex]},s={x:(r.NodeIndex+1)*i,y:e[r.NodeIndex+1]},n=v(a,T(x(s,a),u(r.NodePercent))),c=Q(x(s,a));return{x:n.x+-c.x*r.Distance*Math.sin(r.Sine),y:n.y+c.y*r.Distance*Math.sin(r.Sine)}}updateStar(e,r,i=1){r.Sine+=i*e.flowSpeed*this.deltaTimeMultiplier*this.speedMultiplier,r.NodePercent+=i*.25*e.flowSpeed*this.deltaTimeMultiplier*this.speedMultiplier,r.NodePercent>=1&&(r.NodePercent-=1,r.NodeIndex++,r.NodeIndex>=e.yNodes.length-1&&(r.NodeIndex=0,r.Position.x=0)),r.Position=v(r.Position,C(x(this.targetOfStar(e,r),r.Position),u(50,50)))}render(){this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA),this.gl.blendEquation(this.gl.FUNC_ADD),this.gl.enable(this.gl.BLEND),this.gl.useProgram(this.program),this.gl.uniform1f(this.bindings.flash,0),this.uniformVec2("dim",this.dimensions),this.uniformVec2("scrollPosition",this.scrollPosition),this.uniformVec2("mousePosition",this.mousePosition||u(-1,-1)),this.gl.uniform1f(this.bindings.pointSize,this.isSmallDims()?16:32);for(let e=0;e<this.textures.length;e++){const r=this.textures[e];this.gl.activeTexture(this.gl["TEXTURE"+e]),this.gl.bindTexture(this.gl.TEXTURE_2D,r),this.gl.uniform1i(this.gl.getUniformLocation(this.program,`u_textures[${e}]`),e)}for(let e of this.starfields)this.renderDrawStarfield(e)}renderDrawStarfield(e){this.uniformVec2("scroll",e.config.scroll);const r=parseInt(e.config.color.slice(0,2),16)/255,i=parseInt(e.config.color.slice(2,4),16)/255,a=parseInt(e.config.color.slice(4,6),16)/255;this.gl.uniform3f(this.bindings.color,r,i,a);const s=[],n=[],c=[];e.stars.forEach(A=>{s.push(A.Position.x,A.Position.y),n.push(A.Opacity),c.push(A.Texture)}),this.writeAndBindBuffer("position",this.buffers.position,new Float32Array(s),2),this.writeAndBindBuffer("opacity",this.buffers.opacity,new Float32Array(n)),this.writeAndBindBuffer("textureIndex",this.buffers.texture,new Float32Array(c)),this.gl.drawArrays(this.gl.POINTS,0,e.stars.length)}}const te=({onInitialize:t,onInitializeFail:o,onDestroy:e,onResize:r}={})=>{let i=f.useRef(null),a=f.useRef(null);return f.useEffect(()=>{if(!i.current)return;i.current.width=i.current.clientWidth,i.current.height=i.current.clientHeight;const s=i.current.getContext("webgl2",{antialias:!1,powerPreference:"low-power",desynchronized:!0,failIfMajorPerformanceCaveat:!0});if(!s){console.log("WebGL2RenderingContext initialize failed"),o==null||o();return}return a.current=s,t==null||t(s),s.viewport(0,0,i.current.width,i.current.height),r==null||r(u(i.current.width,i.current.height),i.current),()=>{e==null||e(),a.current=null}},[i.current]),P("resize",()=>{var s;i.current&&(i.current.width=i.current.clientWidth,i.current.height=i.current.clientHeight,(s=a.current)==null||s.viewport(0,0,i.current.width,i.current.height),r==null||r(u(i.current.width,i.current.height),i.current))}),{ref:i,gl:a}},B=({update:t,fps:o=30})=>{f.useEffect(()=>{let e=performance.now();const r=setInterval(()=>{let i=performance.now();t((i-e)/o,i-e),e=i},1e3/o);return()=>clearInterval(r)},[t,o])},re=({render:t,deltaTimeFPS:o=30})=>{B({fps:o,update:(e,r)=>{t(e)}})},oe=({effects:t,onDimensionsChange:o,onInitialized:e})=>{const r=f.useRef([]),i=n=>{for(let c of r.current)G(n,c.dimensions)||c.onDimensionsChange(n);o==null||o(n)},{ref:a,gl:s}=te({onInitialize:n=>{r.current=t.map(([c])=>new c(n)),i({x:n.canvas.width,y:n.canvas.height}),e==null||e()},onDestroy:()=>{r.current=[]},onResize:n=>{i(n)}});return re({render:()=>{var n,c;(n=s.current)==null||n.clearColor(0,0,0,0),(c=s.current)==null||c.clear(s.current.COLOR_BUFFER_BIT);for(let A of r.current)A.render()}}),B({fps:30,update:n=>{for(let c of r.current)c.update(1*n)}}),P("mousemove",n=>{for(let c of r.current)c.onMouseMove(u(n.clientX,n.clientY))}),{ref:a,gl:s,store:r}},ie=()=>{const{ref:t}=oe({effects:[[ee]]});return d.jsxs("div",{className:"pageBackground",children:[d.jsx("div",{id:"rr1",style:{position:"absolute",left:0,bottom:0}}),d.jsx("div",{id:"rr2",style:{position:"absolute",right:0,bottom:0}}),d.jsx("canvas",{className:"pageBackground",style:{width:"100vw",height:"100vh",imageRendering:"pixelated"},ref:t})]})},se=f.createContext({ref:{current:null},analyser:{current:null},audioContext:{current:null},currentSong:null,loading:!0,playing:!1}),ne=({children:t})=>{const o=f.useRef(null),e=f.useRef(null),r=f.useRef(null),[i,a]=f.useState(null),[s,n]=f.useState(!1),[c,A]=f.useState(!1);f.useEffect(()=>{let g=new Audio;return o.current=g,g.loop=!0,()=>{var h;(h=e.current)==null||h.close(),g.pause(),g.remove(),o.current=null}},[]),f.useEffect(()=>{o.current&&(o.current.onplaying=()=>{_.hide("music")})},[o.current]);const S=()=>{var g;(g=o.current)==null||g.play().then(()=>{e.current=new AudioContext;let h=e.current.createMediaElementSource(o.current);r.current=e.current.createAnalyser(),h.connect(r.current),h.connect(e.current.destination)}).catch(h=>{if(h instanceof DOMException&&h.name=="NotAllowedError"){_.show({id:"music",message:"Can't play music, please click anywhere",autoClose:!1});const M=()=>S();window.addEventListener("click",M,{once:!0})}})};return f.useEffect(()=>{o.current&&(o.current.src=(i==null?void 0:i.file)||"",i&&S())},[i]),d.jsx(se.Provider,{value:{ref:o,loading:s,playing:c,currentSong:i,analyser:r,audioContext:e},children:t})},he=N(function(){return d.jsx(O,{children:d.jsx(V,{children:d.jsxs(ne,{children:[d.jsx(ie,{}),d.jsx(D,{})]})})})});export{he as default};
